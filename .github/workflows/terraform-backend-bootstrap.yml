name: Terraform backend bootstrap

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'create or destroy backend resources'
        required: true
        default: 'create'
      bucket:
        description: 'S3 bucket name (optional, falls back to secret TF_STATE_BUCKET)'
        required: false
      table:
        description: 'DynamoDB table name (optional, falls back to secret TF_DDB_TABLE)'
        required: false

permissions:
  contents: read

env:
  AWS_REGION: ap-northeast-1

jobs:
  backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Determine names
        run: |
          echo "BUCKET=${{ github.event.inputs.bucket || secrets.TF_STATE_BUCKET }}" >> $GITHUB_ENV
          echo "TABLE=${{ github.event.inputs.table || secrets.TF_DDB_TABLE }}" >> $GITHUB_ENV

      - name: Create S3 bucket and DynamoDB table
        if: ${{ github.event.inputs.action == 'create' }}
        run: |
          set -e
          echo "Creating S3 bucket: $BUCKET"
          if aws s3api head-bucket --bucket "$BUCKET" 2>/dev/null; then
            echo "Bucket $BUCKET already exists"
          else
            aws s3api create-bucket --bucket "$BUCKET" --region "$AWS_REGION" --create-bucket-configuration LocationConstraint=$AWS_REGION
            aws s3api put-bucket-versioning --bucket "$BUCKET" --versioning-configuration Status=Enabled
            aws s3api put-bucket-encryption --bucket "$BUCKET" --server-side-encryption-configuration '{"Rules":[{"ApplyServerSideEncryptionByDefault":{"SSEAlgorithm":"AES256"}}]}'
            aws s3api put-public-access-block --bucket "$BUCKET" --public-access-block-configuration BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true
            echo "Created and hardened bucket $BUCKET"
          fi

          echo "Creating DynamoDB table: $TABLE"
          if aws dynamodb describe-table --table-name "$TABLE" >/dev/null 2>&1; then
            echo "DynamoDB table $TABLE already exists"
          else
            aws dynamodb create-table --table-name "$TABLE" --attribute-definitions AttributeName=LockID,AttributeType=S --key-schema AttributeName=LockID,KeyType=HASH --billing-mode PAY_PER_REQUEST --region "$AWS_REGION"
            echo "Waiting for table $TABLE to become ACTIVE"
            aws dynamodb wait table-exists --table-name "$TABLE"
            echo "Created DynamoDB table $TABLE"
          fi

      - name: Destroy S3 bucket and DynamoDB table (dangerous)
        if: ${{ github.event.inputs.action == 'destroy' }}
        run: |
          set -e
          echo "Destroying S3 bucket: $BUCKET (will remove all objects)"
          if aws s3api head-bucket --bucket "$BUCKET" 2>/dev/null; then
            aws s3 rm s3://"$BUCKET" --recursive || true
            aws s3api delete-bucket --bucket "$BUCKET" --region "$AWS_REGION" || true
            echo "Bucket $BUCKET deleted (or attempted)"
          else
            echo "Bucket $BUCKET not found"
          fi

          echo "Destroying DynamoDB table: $TABLE"
          if aws dynamodb describe-table --table-name "$TABLE" >/dev/null 2>&1; then
            aws dynamodb delete-table --table-name "$TABLE" --region "$AWS_REGION" || true
            echo "Deleted DynamoDB table $TABLE (or attempted)"
          else
            echo "DynamoDB table $TABLE not found"
          fi
