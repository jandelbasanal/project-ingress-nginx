name: Deploy to EKS

on:
  push:
    branches: [ "master" ]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-northeast-1
  EKS_CLUSTER_NAME: ${{ secrets.EKS_CLUSTER_NAME }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install tools
        run: |
          curl -sLo kubectl https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/
          curl -sLo /tmp/helm.tar.gz https://get.helm.sh/helm-v3.14.4-linux-amd64.tar.gz
          tar -C /tmp -xzf /tmp/helm.tar.gz
          sudo mv /tmp/linux-amd64/helm /usr/local/bin/helm
          curl -sLo /tmp/eksctl.tar.gz https://github.com/weaveworks/eksctl/releases/download/v0.183.0/eksctl_Linux_amd64.tar.gz
          tar -C /tmp -xzf /tmp/eksctl.tar.gz
          sudo mv /tmp/eksctl /usr/local/bin/eksctl

      - name: Ensure EKS cluster exists (create if missing)
        run: |
          if ! aws eks describe-cluster --name "$EKS_CLUSTER_NAME" --region "$AWS_REGION" >/dev/null 2>&1; then
            echo "Cluster $EKS_CLUSTER_NAME not found in $AWS_REGION. Creating via eksctl..."
            eksctl create cluster -f eks/cluster-config.yaml
          else
            echo "Cluster $EKS_CLUSTER_NAME exists."
          fi

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name "$EKS_CLUSTER_NAME" --region "$AWS_REGION"

      - name: Create namespace
        run: |
          kubectl apply -f k8s/namespace.yaml

      - name: Install ingress-nginx via Helm
        run: |
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
          helm repo update
          helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx \
            --namespace ingress-nginx --create-namespace \
            -f helm/ingress-nginx-values.yaml

      - name: Ensure IAM OIDC provider for EKS
        run: |
          eksctl utils associate-iam-oidc-provider --cluster "$EKS_CLUSTER_NAME" --approve --region "$AWS_REGION" || true

      - name: Create IAM policy for ALB Controller (if missing)
        run: |
          POLICY_ARN=$(aws iam list-policies --scope Local --query 'Policies[?PolicyName==`AWSLoadBalancerControllerIAMPolicy`].Arn' --output text || true)
          if [ -z "$POLICY_ARN" ]; then
            curl -sLo iam-policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.7.1/docs/install/iam_policy.json
            aws iam create-policy --policy-name AWSLoadBalancerControllerIAMPolicy --policy-document file://iam-policy.json
          fi

      - name: Create IAM role for service account via eksctl (if missing)
        run: |
          ROLE_NAME="AmazonEKSLoadBalancerControllerRole"
          if ! aws iam get-role --role-name "$ROLE_NAME" >/dev/null 2>&1; then
            eksctl create iamserviceaccount \
              --cluster="$EKS_CLUSTER_NAME" \
              --namespace=kube-system \
              --name=aws-load-balancer-controller \
              --attach-policy-arn=$(aws iam list-policies --scope Local --query 'Policies[?PolicyName==`AWSLoadBalancerControllerIAMPolicy`].Arn' --output text) \
              --override-existing-serviceaccounts \
              --approve \
              --region "$AWS_REGION"
          fi

      - name: Install AWS Load Balancer Controller
        run: |
          helm repo add eks https://aws.github.io/eks-charts
          helm repo update
          helm upgrade --install aws-load-balancer-controller eks/aws-load-balancer-controller \
            -n kube-system \
            --set clusterName=$EKS_CLUSTER_NAME \
            --set region=$AWS_REGION \
            --set serviceAccount.create=false \
            --set serviceAccount.name=aws-load-balancer-controller

      - name: Deploy app manifests
        run: |
          kubectl apply -f k8s/app/deployment.yaml
          kubectl apply -f k8s/app/service.yaml
          kubectl apply -f k8s/app/ingress.yaml

      - name: Wait for Ingress address
        run: |
          for i in {1..60}; do
            echo "Attempt $i: waiting for Ingress hostname..."
            host=$(kubectl -n demo get ingress hello-world -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' || true)
            if [ -n "$host" ]; then echo "ALB Hostname: $host"; echo "$host" > alb_hostname.txt; break; fi
            sleep 10
          done
          test -s alb_hostname.txt

      - name: Upload ALB hostname artifact
        uses: actions/upload-artifact@v4
        with:
          name: alb-hostname
          path: alb_hostname.txt
